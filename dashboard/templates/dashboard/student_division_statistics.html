{% extends 'dashboard/base.html' %}

{% block title %}Student Division Statistics - CampsHub360{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-chart-bar"></i> Student Division Statistics
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'dashboard:student_divisions' %}" class="btn btn-sm btn-outline-info">
                <i class="fas fa-sitemap"></i> View Divisions
            </a>
            <a href="{% url 'dashboard:student_assignments' %}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-user-plus"></i> Assign Students
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label for="department" class="form-label">Department</label>
                <select class="form-select" id="department" name="department">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if filters.department_id == dept.id|stringformat:"s" %}selected{% endif %}>
                        {{ dept.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="academic_year" class="form-label">Academic Year</label>
                <input type="text" class="form-control" id="academic_year" name="academic_year" 
                       placeholder="2023-2024" value="{{ filters.academic_year }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Filter
                    </button>
                    <a href="{% url 'dashboard:student_division_statistics' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Total Students</h5>
                <h2 class="card-text">
                    {% for dept_code, dept_stats in stats.items %}
                        {{ dept_stats.total_students|add:0 }}
                    {% empty %}
                        0
                    {% endfor %}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Active Departments</h5>
                <h2 class="card-text">{{ stats|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Total Programs</h5>
                <h2 class="card-text">
                    {% for dept_code, dept_stats in stats.items %}
                        {{ dept_stats.by_program|length|add:0 }}
                    {% empty %}
                        0
                    {% endfor %}
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body">
                <h5 class="card-title">Average per Dept</h5>
                <h2 class="card-text">
                    {% if stats %}
                        {% widthratio stats|length 1 1 as total_depts %}
                        {% for dept_code, dept_stats in stats %}
                            {% widthratio dept_stats.total_students total_depts 1 as avg %}
                        {% endfor %}
                        {{ avg|floatformat:0 }}
                    {% else %}
                        0
                    {% endif %}
                </h2>
            </div>
        </div>
    </div>
</div>

<!-- Department Statistics -->
<div class="row">
    {% for dept_code, dept_stats in stats.items %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-building"></i> {{ dept_stats.department.name }}
                    <span class="badge bg-primary float-end">{{ dept_stats.total_students }} students</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- Programs -->
                {% if dept_stats.by_program %}
                <div class="mb-3">
                    <h6 class="text-primary">
                        <i class="fas fa-graduation-cap"></i> Programs
                    </h6>
                    <div class="row">
                        {% for program_code, program_data in dept_stats.by_program.items %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span>{{ program_data.name }}</span>
                                <span class="badge bg-info">{{ program_data.count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Year of Study -->
                {% if dept_stats.by_year_of_study %}
                <div class="mb-3">
                    <h6 class="text-success">
                        <i class="fas fa-user-graduate"></i> Year of Study
                    </h6>
                    <div class="row">
                        {% for year, count in dept_stats.by_year_of_study.items %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span>
                                    {% for year_choice, name in year_choices %}
                                        {% if year_choice == year %}{{ name }}{% endif %}
                                    {% endfor %}
                                </span>
                                <span class="badge bg-success">{{ count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Semesters -->
                {% if dept_stats.by_semester %}
                <div class="mb-3">
                    <h6 class="text-warning">
                        <i class="fas fa-book"></i> Semesters
                    </h6>
                    <div class="row">
                        {% for semester, count in dept_stats.by_semester.items %}
                        <div class="col-md-4 mb-2">
                            <div class="d-flex justify-content-between">
                                <span>
                                    {% for sem_choice, name in semester_choices %}
                                        {% if sem_choice == semester %}{{ name }}{% endif %}
                                    {% endfor %}
                                </span>
                                <span class="badge bg-warning">{{ count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Gender Distribution -->
                {% if dept_stats.by_gender %}
                <div class="mb-3">
                    <h6 class="text-info">
                        <i class="fas fa-venus-mars"></i> Gender Distribution
                    </h6>
                    <div class="row">
                        {% for gender, count in dept_stats.by_gender.items %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span>
                                    {% for gender_choice, name in gender_choices %}
                                        {% if gender_choice == gender %}{{ name }}{% endif %}
                                    {% endfor %}
                                </span>
                                <span class="badge bg-info">{{ count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No statistics available</h5>
                <p class="text-muted">No students found with the current filters.</p>
                <a href="{% url 'dashboard:students' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Students
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Summary Chart -->
{% if stats %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-chart-pie"></i> Department Distribution
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for dept_code, dept_stats in stats.items %}
            <div class="col-md-3 mb-3">
                <div class="text-center">
                    <h6>{{ dept_stats.department.name }}</h6>
                    <div class="progress mb-2" style="height: 20px;">
                        {% widthratio dept_stats.total_students stats|length 100 as percentage %}
                        <div class="progress-bar" role="progressbar" style="width: {{ percentage }}%">
                            {{ dept_stats.total_students }}
                        </div>
                    </div>
                    <small class="text-muted">{{ dept_stats.total_students }} students</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form on filter change
document.querySelectorAll('select[name="department"]').forEach(function(select) {
    select.addEventListener('change', function() {
        this.form.submit();
    });
});

// Auto-submit on academic year input with debounce
let yearTimeout;
document.getElementById('academic_year').addEventListener('input', function() {
    clearTimeout(yearTimeout);
    yearTimeout = setTimeout(() => {
        this.form.submit();
    }, 1000);
});
</script>
{% endblock %}



