{% extends 'dashboard/base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h2 class="mb-0">Grade Scales</h2>
  <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createScaleModal"><i class="fas fa-plus"></i> New</button>
</div>

<table class="table table-striped table-hover">
  <thead>
    <tr><th>Letter</th><th>Min</th><th>Max</th><th>Points</th><th>Scope</th><th>Active</th></tr>
  </thead>
  <tbody>
    {% for g in items %}
      <tr>
        <td>{{ g.letter }}</td>
        <td>{{ g.min_score }}</td>
        <td>{{ g.max_score }}</td>
        <td>{{ g.grade_points }}</td>
        <td>
          {% if g.department %}<span class="badge bg-info">Dept: {{ g.department.code }}</span>{% endif %}
          {% if g.program %}<span class="badge bg-secondary">Prog: {{ g.program.code }}</span>{% endif %}
          {% if not g.department and not g.program %}<span class="badge bg-light text-dark">Global</span>{% endif %}
        </td>
        <td>{{ g.is_active }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="5">No grade scales found.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Create modal -->
<div class="modal fade" id="createScaleModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Grade Scale</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createScaleForm">
          <div class="row g-2">
            <div class="col-4"><input class="form-control" name="letter" placeholder="Letter (A)" required></div>
            <div class="col-4"><input class="form-control" name="min_score" placeholder="Min" type="number" step="0.01" required></div>
            <div class="col-4"><input class="form-control" name="max_score" placeholder="Max" type="number" step="0.01" required></div>
            <div class="col-6"><input class="form-control" name="grade_points" placeholder="Points" type="number" step="0.01" required></div>
            <div class="col-6">
              <select class="form-select" name="is_active">
                <option value="true" selected>Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>
            <div class="col-6">
              <select class="form-select" name="department">
                <option value="">Department (optional)</option>
                {% for d in departments %}
                  <option value="{{ d.id }}">{{ d.code }} - {{ d.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6">
              <select class="form-select" name="program">
                <option value="">Program (optional)</option>
                {% for p in programs %}
                  <option value="{{ p.id }}">{{ p.code }} - {{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="createScaleBtn">Create</button>
      </div>
    </div>
  </div>
  </div>

{% block extra_js %}
<script>
  document.getElementById('createScaleBtn').addEventListener('click', async function() {
    const form = document.getElementById('createScaleForm');
    const data = Object.fromEntries(new FormData(form).entries());
    data.is_active = data.is_active === 'true';
    if (!data.department) data.department = null; else data.department = parseInt(data.department);
    if (!data.program) data.program = null; else data.program = parseInt(data.program);
    const res = await fetch('/api/v1/grads/grade-scales/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('jwt')||''}` },
      body: JSON.stringify(data)
    });
    if (res.ok) { location.reload(); } else { alert('Failed to create scale'); }
  });
</script>
{% endblock %}
{% endblock %}


