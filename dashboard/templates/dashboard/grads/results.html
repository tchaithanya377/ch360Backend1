{% extends 'dashboard/base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-2">
  <h2 class="mb-0">Course Results</h2>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary btn-sm" href="{% url 'dashboard:grads_bulk_entry' %}"><i class="fas fa-table"></i> Bulk Entry</a>
    <a class="btn btn-primary btn-sm" href="#" data-bs-toggle="modal" data-bs-target="#addResultModal"><i class="fas fa-plus"></i> Add Result</a>
  </div>
</div>
<form method="get" class="row g-2 align-items-end" style="margin-bottom:12px;">
  <div class="col-3">
    <select class="form-select" name="student">
      <option value="">All Students</option>
      {% for s in students_list %}
        <option value="{{ s.id }}" {% if request.GET.student == s.id|stringformat:'s' %}selected{% endif %}>{{ s.roll_number }} - {{ s.full_name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-3">
  <select class="form-select" name="term">
    <option value="">All Terms</option>
    {% for t in terms %}
      <option value="{{ t.id }}" {% if request.GET.term == t.id|stringformat:'s' %}selected{% endif %}>{{ t.academic_year }} {{ t.get_semester_display }}</option>
    {% endfor %}
  </select>
  </div>
  <div class="col-3"><input class="form-control" type="text" name="department" placeholder="Dept code (e.g., CS)" value="{{ request.GET.department }}"/></div>
  <div class="col-3">
    <select class="form-select" name="course">
      <option value="">All Courses</option>
      {% for c in courses %}
        <option value="{{ c.id }}" {% if request.GET.course == c.id|stringformat:'s' %}selected{% endif %}>{{ c.code }} - {{ c.title }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-3">
    <select class="form-select" name="year">
      <option value="">All Years</option>
      {% for y in years %}
        <option value="{{ y }}" {% if request.GET.year == y %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-3">
    <select class="form-select" name="section">
      <option value="">All Sections</option>
      {% for s in sections %}
        <option value="{{ s }}" {% if request.GET.section == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-3 d-flex gap-2">
    <button class="btn btn-outline-primary" type="submit">Filter</button>
    <a class="btn btn-light" href="{% url 'dashboard:grads_results' %}">Reset</a>
  </div>
 </form>

<div class="table-responsive"><table class="table table-striped table-hover">
  <thead>
    <tr><th>Student</th><th>Term</th><th>Course</th><th>Internal</th><th>External</th><th>Total</th><th>Grade</th><th>Points</th><th>Passed</th></tr>
  </thead>
  <tbody>
    {% for r in results %}
      <tr>
        <td><a href="{% url 'dashboard:grads_transcript' r.student.id %}">{{ r.student.roll_number }}</a></td>
        <td>{{ r.term.academic_year }} {{ r.term.get_semester_display }}</td>
        <td>{{ r.course_section.course.code }} - {{ r.course_section.course.title }}</td>
        <td>{{ r.internal_marks }}</td>
        <td>{{ r.external_marks }}</td>
        <td>{{ r.total_marks }}</td>
        <td>{{ r.letter_grade }}</td>
        <td>{{ r.grade_points }}</td>
        <td>{{ r.passed }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="9">No results found.</td></tr>
    {% endfor %}
  </tbody>
</table></div>

<!-- Add Result Modal -->
<div class="modal fade" id="addResultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Add Course Result</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="addResultForm" class="row g-2">
          <div class="col-6">
            <select class="form-select" name="student" required>
              <option value="">Select Student</option>
              {% for s in students_list %}
                <option value="{{ s.id }}">{{ s.roll_number }} - {{ s.full_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6">
            <select class="form-select" name="term" required>
              <option value="">Select Term</option>
              {% for t in terms %}
                <option value="{{ t.id }}">{{ t.academic_year }} {{ t.get_semester_display }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12">
            <select class="form-select" name="course_section" required>
              <option value="">Select Course Section</option>
              {% for cs in course_sections %}
                <option value="{{ cs.id }}">{{ cs.course.code }} - {{ cs.course.title }} | Section {{ cs.section_number }} | {{ cs.academic_year }} {{ cs.semester }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6"><input class="form-control" name="internal_marks" placeholder="Internal Marks" type="number" step="0.01" required></div>
          <div class="col-6"><input class="form-control" name="external_marks" placeholder="External Marks" type="number" step="0.01" required></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveResultBtn">Save</button>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  document.getElementById('saveResultBtn').addEventListener('click', async function() {
    const data = Object.fromEntries(new FormData(document.getElementById('addResultForm')).entries());
    data.internal_marks = parseFloat(data.internal_marks);
    data.external_marks = parseFloat(data.external_marks);
    const res = await fetch('/api/v1/grads/course-results/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('jwt')||''}` },
      body: JSON.stringify(data)
    });
    if (res.ok) { location.reload(); } else { alert('Failed to save result. Ensure you are assigned faculty for the section.'); }
  });
</script>
{% endblock %}
{% endblock %}


