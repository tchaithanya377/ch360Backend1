{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Hall Tickets - CampsHub360{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-ticket-alt text-primary"></i>
            Hall Tickets
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-success" onclick="generateBulkTickets()">
                    <i class="fas fa-download"></i> Generate Bulk
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.href='{% url 'dashboard:exams_dashboard' %}'">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search tickets...">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="statusFilter">
                <option value="">All Statuses</option>
                <option value="DRAFT">Draft</option>
                <option value="GENERATED">Generated</option>
                <option value="PRINTED">Printed</option>
                <option value="ISSUED">Issued</option>
                <option value="USED">Used</option>
                <option value="EXPIRED">Expired</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="buildingFilter">
                <option value="">All Buildings</option>
                {% for building in buildings %}
                    <option value="{{ building }}">{{ building }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Hall Tickets List -->
    <div class="card shadow">
        <div class="card-body">
            {% if hall_tickets %}
                <div class="table-responsive">
                    <table class="table table-hover" id="ticketsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Ticket Number</th>
                                <th>Student</th>
                                <th>Course & Exam</th>
                                <th>Date & Time</th>
                                <th>Room & Seat</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in hall_tickets %}
                            <tr>
                                <td>
                                    <strong class="text-primary">{{ ticket.ticket_number }}</strong><br>
                                    <small class="text-muted">Generated: {{ ticket.generated_date|date:"M d, Y" }}</small>
                                </td>
                                <td>
                                    <strong>{{ ticket.exam_registration.student.roll_number }}</strong><br>
                                    <small class="text-muted">{{ ticket.exam_registration.student.first_name }} {{ ticket.exam_registration.student.last_name }}</small>
                                </td>
                                <td>
                                    <strong>{{ ticket.exam_registration.exam_schedule.course.code }}</strong><br>
                                    <small class="text-muted">{{ ticket.exam_registration.exam_schedule.title }}</small>
                                </td>
                                <td>
                                    <strong>{{ ticket.exam_registration.exam_schedule.exam_date|date:"M d, Y" }}</strong><br>
                                    <small class="text-muted">{{ ticket.exam_registration.exam_schedule.start_time|time:"H:i" }} - {{ ticket.exam_registration.exam_schedule.end_time|time:"H:i" }}</small>
                                </td>
                                <td>
                                    {% if ticket.exam_room %}
                                        <strong>{{ ticket.exam_room.name }}</strong><br>
                                        <small class="text-muted">{{ ticket.exam_room.building }}{% if ticket.seat_number %} - Seat {{ ticket.seat_number }}{% endif %}</small>
                                    {% else %}
                                        <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if ticket.status == 'DRAFT' %}
                                        <span class="badge bg-secondary">Draft</span>
                                    {% elif ticket.status == 'GENERATED' %}
                                        <span class="badge bg-primary">Generated</span>
                                    {% elif ticket.status == 'PRINTED' %}
                                        <span class="badge bg-info">Printed</span>
                                    {% elif ticket.status == 'ISSUED' %}
                                        <span class="badge bg-success">Issued</span>
                                    {% elif ticket.status == 'USED' %}
                                        <span class="badge bg-warning">Used</span>
                                    {% elif ticket.status == 'EXPIRED' %}
                                        <span class="badge bg-danger">Expired</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'dashboard:exams_hall_ticket_detail' ticket.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-success" onclick="downloadTicket('{{ ticket.id }}')">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="printTicket('{{ ticket.id }}')">
                                            <i class="fas fa-print"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="issueTicket('{{ ticket.id }}')">
                                            <i class="fas fa-hand-holding"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No hall tickets found</h5>
                    <p class="text-muted">Hall tickets are generated automatically when exam registrations are approved.</p>
                    <button type="button" class="btn btn-primary" onclick="location.href='{% url 'dashboard:exams_registrations' %}'">
                        <i class="fas fa-user-check"></i> Manage Registrations
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bulk Generation Modal -->
<div class="modal fade" id="bulkGenerationModal" tabindex="-1" aria-labelledby="bulkGenerationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkGenerationModalLabel">Generate Hall Tickets in Bulk</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'dashboard:exams_hall_tickets' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="exam_schedule" class="form-label">Select Exam Schedule</label>
                        <select class="form-select" id="exam_schedule" name="exam_schedule" required>
                            <option value="">Select Schedule</option>
                            {% for schedule in exam_schedules %}
                                <option value="{{ schedule.id }}">{{ schedule.course.code }} - {{ schedule.title }} ({{ schedule.exam_date|date:"M d, Y" }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="room_assignment" class="form-label">Room Assignment</label>
                        <select class="form-select" id="room_assignment" name="room_assignment">
                            <option value="">Auto-assign rooms</option>
                            <option value="manual">Manual assignment</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        This will generate hall tickets for all approved registrations in the selected exam schedule.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Generate Tickets</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const table = document.getElementById('ticketsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
});

// Status filter
document.getElementById('statusFilter').addEventListener('change', function() {
    const filterValue = this.value.toLowerCase();
    const table = document.getElementById('ticketsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const statusCell = row.querySelector('td:nth-child(6)');
        if (statusCell) {
            const status = statusCell.textContent.toLowerCase();
            row.style.display = !filterValue || status.includes(filterValue) ? '' : 'none';
        }
    }
});

// Building filter
document.getElementById('buildingFilter').addEventListener('change', function() {
    const filterValue = this.value.toLowerCase();
    const table = document.getElementById('ticketsTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const roomCell = row.querySelector('td:nth-child(5)');
        if (roomCell) {
            const room = roomCell.textContent.toLowerCase();
            row.style.display = !filterValue || room.includes(filterValue) ? '' : 'none';
        }
    }
});

// Bulk ticket generation
function generateBulkTickets() {
    const modal = new bootstrap.Modal(document.getElementById('bulkGenerationModal'));
    modal.show();
}

// Download ticket function
function downloadTicket(ticketId) {
    // Implement download functionality
    console.log('Download ticket:', ticketId);
    window.open(`/api/v1/exams/hall-tickets/${ticketId}/download_pdf/`, '_blank');
}

// Print ticket function
function printTicket(ticketId) {
    // Implement print functionality
    console.log('Print ticket:', ticketId);
}

// Issue ticket function
function issueTicket(ticketId) {
    if (confirm('Mark this ticket as issued to student?')) {
        // Implement issue functionality
        console.log('Issue ticket:', ticketId);
    }
}
</script>
{% endblock %}
